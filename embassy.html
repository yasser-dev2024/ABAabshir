<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø³ÙØ§Ø±Ø©</title>

    <link rel="stylesheet" href="libs/tailwind.css" />
    <link rel="stylesheet" href="style.css" />

    <style>

        /* ğŸ”¥ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© */
        html, body {
            height: 100%;
            overflow-y: auto !important;
        }

        .page-wrapper {
            min-height: calc(100vh - 90px);
            padding: 10px 18px;
        }

        .space-y-5 > * {
            margin-top: 8px !important;
            margin-bottom: 8px !important;
        }

        input, textarea, select, button {
            padding: 8px 12px !important;
        }

        textarea {
            height: 70px !important;
        }

        .footer-bar {
            width: 100%;
            height: 70px;
            background-color: #009639;
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: 9999;
        }

        /* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
        #recordingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 999999;
            padding: 0;
        }

        #recordingVideo {
            width: 90%;
            max-width: 500px;
            height: auto;
            border-radius: 15px;
            background: #000;
        }

        #recordingCounter {
            color: #fff;
            font-size: 38px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        #sendingCounterBox {
            position: fixed;
            bottom: 90px;
            left: 0;
            width: 100%;
            text-align: center;
            display: none;
            z-index: 999999;
        }

        #sendingCounter {
            padding: 12px 20px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            font-size: 22px;
            border-radius: 12px;
            width: fit-content;
            margin: auto;
        }

        .back-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            background: rgba(0,0,0,0.4);
            color: #fff;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-size: 20px;
            z-index: 999999;
            backdrop-filter: blur(4px);
        }
    </style>
</head>

<body class="font-[Cairo]">

    <!-- Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© -->
    <a href="index.html" class="back-btn">â†©</a>

    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ -->
    <div id="recordingScreen">
        <div id="recordingCounter">15</div>
        <video id="recordingVideo" autoplay muted playsinline></video>
    </div>

    <!-- Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
    <div id="sendingCounterBox">
        <div id="sendingCounter">Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø®Ù„Ø§Ù„ 10 Ø«ÙˆØ§Ù†Ùâ€¦</div>
    </div>

    <!-- ===== Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ===== -->
    <div class="page-wrapper">

        <h2 class="text-center text-lg font-bold text-green-700 mb-2">
            Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø³ÙØ§Ø±Ø©
        </h2>

        <div class="space-y-5">

            <div>
                <label class="font-bold text-gray-700 text-sm">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
                <button onclick="detectLocation()" 
                    class="w-full bg-blue-600 text-white mt-1 py-2 rounded-xl font-bold shadow hover:bg-blue-700">
                    ØªØ­Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ø¨Ø± Google Map
                </button>
                <p id="locationStatus" class="text-xs text-gray-600 mt-1"></p>
            </div>

            <div>
                <label class="font-bold text-gray-700 text-sm">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„Ø§Øº</label>
                <select id="reportType" class="w-full mt-1 p-2 rounded-xl shadow border bg-white text-sm">
                    <option selected disabled>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„Ø§Øº</option>
                    <option>Ø¨Ù„Ø§Øº Ø£Ù…Ù†ÙŠ</option>
                    <option>Ø¨Ù„Ø§Øº Ø·Ø§Ø±Ø¦</option>
                    <option>ÙÙ‚Ø¯Ø§Ù† Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±</option>
                    <option>Ø·Ù„Ø¨ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ø¬Ù„Ø©</option>
                    <option>Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ø§Ù…</option>
                </select>
            </div>

            <div>
                <label class="font-bold text-gray-700 text-sm">ÙˆØµÙ Ø§Ù„Ø­Ø§Ù„Ø©</label>
                <textarea id="details"
                    class="w-full mt-1 p-2 rounded-xl shadow border bg-white text-sm"
                    placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§Øº Ù‡Ù†Ø§..."></textarea>
            </div>

            <div>
                <label class="font-bold text-gray-700 text-sm">Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù Ø£Ùˆ ØµÙˆØ±Ø©</label>
                <input type="file" id="attachment"
                       class="w-full mt-1 p-2 rounded-xl shadow border bg-white text-sm">
            </div>

            <button onclick="startEmergencyVideo()"
                class="w-full bg-red-600 text-white py-2 rounded-xl font-bold shadow hover:bg-red-700">
                ØªØ´ØºÙŠÙ„ ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ (ÙŠØ³Ø¬Ù‘Ù„ 15 Ø«Ø§Ù†ÙŠØ©)
            </button>

            <video id="preview" class="w-full rounded-xl hidden mt-1"></video>

            <!-- ğŸ”¥ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª -->
            <button onclick="sendForm()"
                class="w-full bg-green-700 text-white py-3 rounded-xl text-lg font-bold shadow hover:bg-green-800">
                Ø¥Ø±Ø³Ø§Ù„ ÙÙ‚Ø·
            </button>

            <a href="index.html"
                class="block text-center bg-gray-300 text-gray-800 py-3 rounded-xl text-lg font-bold shadow hover:bg-gray-400">
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </a>
        </div>
    </div>

    <div class="footer-bar"></div>

    <!-- Ø³ÙƒØ±Ø¨ØªØ§Øª -->
    <script>

        function detectLocation() {

            if (!navigator.geolocation) {
                locationStatus.textContent = "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
                return;
            }

            locationStatus.textContent = "Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒâ€¦";

            navigator.geolocation.getCurrentPosition(async (position) => {

                let lat = position.coords.latitude;
                let lng = position.coords.longitude;

                try {
                    let url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`;

                    let res = await fetch(url);
                    let data = await res.json();

                    let country = data.address.country || "";
                    let city = data.address.city || data.address.town || data.address.village || "";

                    locationStatus.textContent = `Ø£Ù†Øª ÙÙŠ ${country} â€“ ${city}`;

                } 
                catch {
                    locationStatus.textContent = "ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
                }

            }, () => {
                locationStatus.textContent = "ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
            });
        }

        let autoSendTimer;
        let sendCountdownInterval;

        function startEmergencyVideo() {

            const screen = document.getElementById("recordingScreen");
            const liveVideo = document.getElementById("recordingVideo");
            const counter = document.getElementById("recordingCounter");
            const sendingBox = document.getElementById("sendingCounterBox");
            const sendingCounter = document.getElementById("sendingCounter");
            const fileInput = document.getElementById("attachment");
            const savedVideoPreview = document.getElementById("preview");

            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(async (stream) => {

                    screen.style.display = "flex";
                    liveVideo.srcObject = stream;
                    liveVideo.play();

                    let recorder = new MediaRecorder(stream);
                    let chunks = [];

                    let count = 15;
                    counter.innerText = count;

                    let countdownInterval = setInterval(() => {
                        count--;
                        counter.innerText = count;

                        if (count <= 0) {
                            clearInterval(countdownInterval);
                        }
                    }, 1000);

                    recorder.ondataavailable = e => chunks.push(e.data);

                    recorder.onstop = () => {

                        screen.style.display = "none";

                        let blob = new Blob(chunks, { type: "video/mp4" });
                        let file = new File([blob], "emergency.mp4", { type: "video/mp4" });

                        let dt = new DataTransfer();
                        dt.items.add(file);
                        fileInput.files = dt.files;

                        savedVideoPreview.classList.remove("hidden");
                        savedVideoPreview.src = URL.createObjectURL(blob);

                        sendingBox.style.display = "block";

                        let sendCount = 10;
                        sendingCounter.innerText = `Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø®Ù„Ø§Ù„ ${sendCount} Ø«ÙˆØ§Ù†Ùâ€¦`;

                        sendCountdownInterval = setInterval(() => {
                            sendCount--;
                            sendingCounter.innerText = `Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø®Ù„Ø§Ù„ ${sendCount} Ø«ÙˆØ§Ù†Ùâ€¦`;

                            if (sendCount <= 0) {
                                clearInterval(sendCountdownInterval);
                                sendingBox.style.display = "none";
                                sendForm();
                            }
                        }, 1000);
                    };

                    recorder.start();

                    setTimeout(() => {
                        recorder.stop();
                        stream.getTracks().forEach(t => t.stop());
                    }, 15000);
                })
                .catch(() => {
                    alert("ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§!");
                });
        }

        function sendForm() {
            alert("âœ” ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙØ§Ø±Ø©.");
        }
    </script>

</body>
</html>
