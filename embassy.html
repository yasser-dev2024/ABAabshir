<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ุงูุชูุงุตู ูุน ุงูุณูุงุฑุฉ</title>

    <link rel="stylesheet" href="libs/tailwind.css" />
    <link rel="stylesheet" href="style.css" />

    <style>
        /* ููุน ุชูุฑูุฑ ุงูุตูุญุฉ */
        body, html {
            overflow: hidden;
            height: 100%;
        }

        /* ุฌุนู ุงููุญุชูู ูุชุญุฑู ุฏุงุฎูููุง ููุท */
        .page-wrapper {
            height: 100vh;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 120px;
        }
    </style>
</head>

<body class="font-[Cairo]">

    <!-- ===== ูุงูุฐุฉ ูุชุฑุฌู ุงูุฅุดุงุฑุฉ ===== -->
    <div id="signBox"
         style="
         position: fixed;
         bottom: 20px;
         left: 20px;
         width: 140px;
         height: 200px;
         background: rgba(0,0,0,0.55);
         border-radius: 15px;
         backdrop-filter: blur(6px);
         padding: 10px;
         display: flex;
         align-items: center;
         justify-content: center;
         color: #fff;
         font-weight: bold;
         text-align: center;
         font-size: 14px;
         z-index: 999999;">
         ูุฑุฑ ุงููุงูุณ ุนูู ุงููุต<br>ูุนุฑุถ ูุบุฉ ุงูุฅุดุงุฑุฉ
    </div>

    <!-- ===== ุตูุญุฉ ูุงููุฉ ===== -->
    <div class="page-wrapper">

        <h2 class="text-center text-xl font-bold text-green-700 mb-4">
            ุงูุชูุงุตู ูุน ุงูุณูุงุฑุฉ
        </h2>

        <div class="space-y-5">

            <!-- ุชุญุฏูุฏ ุงููููุน -->
            <div>
                <label class="font-bold text-gray-700">ุชุญุฏูุฏ ุงููููุน</label>
                <button onclick="detectLocation()" 
                    class="w-full bg-blue-600 text-white mt-2 py-3 rounded-xl font-bold shadow hover:bg-blue-700">
                    ุชุญุฏูุฏ ุชููุงุฆู ุนุจุฑ Google Map
                </button>
                <p id="locationStatus" class="text-sm text-gray-600 mt-1"></p>
            </div>

            <!-- ููุน ุงูุจูุงุบ -->
            <div>
                <label class="font-bold text-gray-700">ููุน ุงูุจูุงุบ</label>
                <select id="reportType" class="w-full mt-2 p-3 rounded-xl shadow border bg-white">
                    <option selected disabled>ุงุฎุชุฑ ููุน ุงูุจูุงุบ</option>
                    <option>ุจูุงุบ ุฃููู</option>
                    <option>ุจูุงุบ ุทุงุฑุฆ</option>
                    <option>ููุฏุงู ุฌูุงุฒ ุงูุณูุฑ</option>
                    <option>ุทูุจ ูุณุงุนุฏุฉ ุนุงุฌูุฉ</option>
                    <option>ุงุณุชูุณุงุฑ ุนุงู</option>
                </select>
            </div>

            <!-- ูุตู ุงูุญุงูุฉ -->
            <div>
                <label class="font-bold text-gray-700">ูุตู ุงูุญุงูุฉ</label>
                <textarea id="details" rows="4"
                    class="w-full mt-2 p-3 rounded-xl shadow border bg-white"
                    placeholder="ุงูุชุจ ุชูุงุตูู ุงูุจูุงุบ ููุง..."></textarea>
            </div>

            <!-- ุฅุฑูุงู ููู -->
            <div>
                <label class="font-bold text-gray-700">ุฅุฑูุงู ููู ุฃู ุตูุฑุฉ</label>
                <input type="file" id="attachment"
                       class="w-full mt-2 p-3 rounded-xl shadow border bg-white">
            </div>

            <!-- ูุงููุฑุง ุงูุทูุงุฑุฆ -->
            <button onclick="startEmergencyVideo()"
                class="w-full bg-red-600 text-white py-3 rounded-xl font-bold shadow hover:bg-red-700">
                ุชุดุบูู ูุงููุฑุง ุงูุทูุงุฑุฆ (ูุณุฌูู 15 ุซุงููุฉ)
            </button>

            <video id="preview" class="w-full rounded-xl hidden mt-3"></video>

            <!-- ุฅุฑุณุงู ุงูุจูุงุบ -->
            <button id="sendBtn" onclick="sendForm()"
                class="w-full bg-green-700 text-white py-4 rounded-xl text-lg font-bold shadow hover:bg-green-800">
                ุฅุฑุณุงู ุงูุจูุงุบ
            </button>

            <!-- ุงูุนูุฏุฉ -->
            <a href="index.html"
                class="block text-center bg-gray-300 text-gray-800 py-4 rounded-xl text-lg font-bold shadow hover:bg-gray-400">
                ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ
            </a>
        </div>
    </div>

    <!-- ========== ุณูุฑุจุชุงุช ========== -->
    <script>

        /* =====================================================
           ุชุญุฏูุฏ ุงูุฏููุฉ + ุงููุฏููุฉ ุชููุงุฆูุงู
        ===================================================== */
        function detectLocation() {

            if (!navigator.geolocation) {
                locationStatus.textContent = "ุงููุชุตูุญ ูุง ูุฏุนู ุชุญุฏูุฏ ุงููููุน.";
                return;
            }

            locationStatus.textContent = "ุฌุงุฑู ุชุญุฏูุฏ ูููุนูโฆ";

            navigator.geolocation.getCurrentPosition(async (position) => {

                let lat = position.coords.latitude;
                let lng = position.coords.longitude;

                try {
                    let url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`;

                    let res = await fetch(url);
                    let data = await res.json();

                    let country = data.address.country || "";
                    let city = data.address.city || data.address.town || data.address.village || "";

                    locationStatus.textContent = `ุฃูุช ูู ${country} โ ${city}`;

                } 
                catch {
                    locationStatus.textContent = "ุชุนุฐูุฑ ุชุญุฏูุฏ ุงููููุน.";
                }

            }, () => {
                locationStatus.textContent = "ูุดู ุชุญุฏูุฏ ุงููููุน.";
            });
        }


        /* =====================================================
           ูุงููุฑุง ุงูุทูุงุฑุฆ + ุฅุฑูุงู ุชููุงุฆู + ุฅุฑุณุงู ุชููุงุฆู
        ===================================================== */
        let autoSendTimer;

        function startEmergencyVideo() {
            let video = document.getElementById("preview");
            let fileInput = document.getElementById("attachment");

            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(async (stream) => {

                    video.srcObject = stream;
                    video.classList.remove("hidden");
                    video.play();

                    // ุงูุชุณุฌูู
                    let recorder = new MediaRecorder(stream);
                    let chunks = [];

                    recorder.ondataavailable = e => chunks.push(e.data);

                    recorder.onstop = () => {

                        let blob = new Blob(chunks, { type: "video/mp4" });
                        let file = new File([blob], "emergency.mp4", { type: "video/mp4" });

                        // ุฅุฑูุงู ุงูููู ุชููุงุฆูุงู
                        let dt = new DataTransfer();
                        dt.items.add(file);
                        fileInput.files = dt.files;

                        video.classList.add("hidden");

                        alert("๐ฅ ุชู ุชุณุฌูู ููุฏูู ุงูุทูุงุฑุฆ ูุฅุฑูุงูู ุชููุงุฆูุงู!");

                        // ุนุฏ ุชูุงุฒูู 10 ุซูุงูู
                        autoSendTimer = setTimeout(() => {
                            sendForm();
                        }, 10000);
                    };

                    recorder.start();

                    // 15 ุซุงููุฉ
                    setTimeout(() => {
                        recorder.stop();
                        stream.getTracks().forEach(t => t.stop());
                    }, 15000);
                })
                .catch(() => alert("ูุดู ุชุดุบูู ุงููุงููุฑุง!"));
        }


        function sendForm() {
            clearTimeout(autoSendTimer);
            alert("โ ุชู ุฅุฑุณุงู ุงูุจูุงุบ ุจูุฌุงุญ ุฅูู ุงูุณูุงุฑุฉ.");
        }
    </script>

    <script src="smart-access.js"></script>

    <!-- ======================================================
         ุงูููุณ ุงููุงุทู + ูุฑุงุกุฉ ุงูููุงุฆู
    ======================================================= -->
    <script>
        const signBox = document.getElementById("signBox");

        const signDictionary = {
            "ุงูุณูุงุฑุฉ": "๐ค ุฅุดุงุฑุฉ ุงูุณูุงุฑุฉ",
            "ุชุญุฏูุฏ": "๐",
            "ูููุน": "๐",
            "ุจูุงุบ": "โ ุจูุงุบ",
            "ุฃููู": "โ ุฃููู",
            "ุทุงุฑุฆ": "๐จ",
            "ูุณุงุนุฏุฉ": "๐ ูุณุงุนุฏุฉ",
            "ุฌูุงุฒ": "๐",
            "ุณูุฑ": "โ๏ธ",
            "ุฅุฑุณุงู": "๐ค",
            "ุนูุฏุฉ": "โฉ๏ธ",
            "ููู": "๐",
            "ุตูุฑุฉ": "๐ท",
            "ููุฏูู": "๐ฅ",
            "ุงูุฅุดุงุฑุฉ": "โ",
            "ูุฑุงุกุฉ": "๐",
            "ูุต": "๐"
        };

        document.addEventListener("mouseover", function (e) {
            let text = e.target.innerText.trim();
            if (text.length === 0) return;

            window.speechSynthesis.cancel();

            const speak = new SpeechSynthesisUtterance(text);
            speak.lang = "ar-SA";
            speak.rate = 1.05;
            window.speechSynthesis.speak(speak);

            let found = null;
            for (let w of text.split(" ")) {
                if (signDictionary[w]) {
                    found = signDictionary[w];
                    break;
                }
            }

            signBox.innerText = found ? found : "๐ค ุฅุดุงุฑุฉ ุงููุต";
        });
    </script>

</body>
</html>
